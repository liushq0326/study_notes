- [http](#http)
  - [一、http基本原理](#一http基本原理)
    - [1.1 概念](#11-概念)
    - [1.2MIME(多用途因特网邮件扩展)](#12mime多用途因特网邮件扩展)
    - [1.3 网络地址的基本信息](#13-网络地址的基本信息)
  - [二、HTTP请求的事务逻辑](#二http请求的事务逻辑)
    - [2.1 概念](#21-概念)
    - [2.2 HTTP请求的事务逻辑之连接](#22-http请求的事务逻辑之连接)
    - [2.3 TCP/IP的三次握手/四次挥手](#23-tcpip的三次握手四次挥手)
    - [2.4 常见的业务结构组件](#24-常见的业务结构组件)
  - [三、HTTP报文](#三http报文)
    - [3.1 报文流入源端服务器](#31-报文流入源端服务器)
    - [3.1 报文格式详解](#31-报文格式详解)
    - [3.2 报文状态码详解](#32-报文状态码详解)
    - [3.3 报文首部详解](#33-报文首部详解)
    - [3.4 抓包小工具Fiddler](#34-抓包小工具fiddler)
# http
## 一、http基本原理

### 1.1 概念

Web 内容都是存储在Web 服务器上的。Web 服务器所使用的是HTTP 协议，因此经常会被称为HTTP 服务器。这些HTTP 服务器存储了因特网中的数据，如果HTTP 客户端发出请求的话，它们会提供数据。客户端向服务器发送HTTP 请求，服务器会在HTTP 响应中回送所请求的数据，HTTP 客户端(比如浏览器)和HTTP服务器共同构成了万维网的基本组件。

### 1.2MIME(多用途因特网邮件扩展)

MIME 类型是一种文本标记，表示一种主要的对象类型和一个特定的子类型，中间由一条斜杠来分隔。

Web 服务器会为所有HTTP 对象数据附加一个MIME 类型当Web浏览器从服务器中取回一个对象时，会去查看相关的MIME 类型，看看它是否知道应该如何处理这个对象。大多数浏览器都可以处理数百种常见的对象类型：显示图片文件、解析并格式化HTML 文件、通过计算机声卡播放音频文件，或者运行外部5 插件软件来处理特殊格式的数据。

Content-type: image/jpeg   image/svg+xml
Content-length: 12984
* Content-type
  * HTML 格式的文本文档由 text/html 类型来标记。
  * 普通的 ASCII 文本文档由 text/plain 类型来标记。
  * JPEG 格式的图片为 image/jpeg 类型。
  * GIF 格式的图片为 image/gif 类型。
  * Apple 的 QuickTime 电影为 video/quicktime 类型。
  * 微软的 PowerPoint 演示文件为 application/vnd.ms-powerpoint 类型。

### 1.3 网络地址的基本信息

每个Web 服务器资源都有一个名字，这样客户端就可以说明它们感兴趣的资源是什么了。服务器资源名被称为统一资源标识符（Uniform Resource Identifier，URI）。URI 就像因特网上的邮政地址一样，在世界范围内唯一标识并定位信息资源。

统一资源定位符（URL）是资源标识符最常见的形式。URL 描述了一台特定服务器上某资源的特定位置。它们可以明确说明如何从一个精确、固定的位置获取资源。

* 大部分URL 都遵循一种标准格式，这种格式包含三个部分。
  * URL 的第一部分被称为方案（scheme），说明了访问资源所使用的协议类型。这
  部分通常就是HTTP 协议（http://）。
  * 第二部分给出了服务器的因特网地址（比如，www.joes-hardware.com）。
  * 其余部分指定了 Web 服务器上的某个资源（比如，/specials/saw-blade.gif）。
  现在，几乎所有的URI 都是URL。
* 大多数URL 方案的URL 语法都建立在这个由9 部分构成的通用格式上：
```html
<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>
```
  * 方案：访问服务器以获取资源时要使用哪种协议
  * 用户：某些方案访问资源时需要用户名
  * 密码：用户名后面可能需要包含密码，用冒号分隔
  * 主机：资源宿主服务器的主机名或点分IP地址
  * 端口：资源宿主服务器正在监听的端口号，很多方案都有默认端口号（HTTP的默认端口号为80）
  * 路径：服务器上资源的本地名，由一个斜杠将其与前面的URL组件分隔开来，路径组件的语法是与服务器和方案有关的
  * 参数：某些方案会用这个组件来指定输入参数。参数为名/值对。URL中可以包含多个参数字段，它们相互之间以及与路径的其余部分之间用分号(;)分隔
  * 查询：某些方案会用这个组件传递参数以激活应用程序（比如数据库、公告板、搜索引擎以及其他因特网网关）。查询组件的内容没有通用格式。用字符“?”将其与URL的其余部分分隔开来。
  * 片段：一小片或一部分资源的名字。引用对象时，不会将frag字段传送给服务器，这个字段是在客户端内部使用的。通过字符“#”将其其与URL的其余部分分隔开来

几乎没有哪个URL 中包含了所有这些组件(不同类型的URL包含了里面的几个不同的部分)
URL 最重要的3 个部分是方案（scheme）、主机（host）和路径（path）

* 方案
  * file：方案file表示一台指定主机（通过本地磁盘，网络文件系统或其他一些文件共享系统）上可直接访问的文件。各字段都遵循用户格式。本地主机可以省略主机名。
  ```html
  基本格式：
  file://<host>/<path>
  示例：
  file://OFFICE-FS/policies/c.doc
  ```
  * news：用户来访问一些特定的文章或新闻组。它有一个很独特的性质：news URL自身包含的信息不足以对资源进行定位。
  ```html
  其他格式： 
    news:<newsgroup>
    news:<news-article-id>
  示例：
    news:rec.arts.startrek
  ```
  * telnet：用户访问交互式业务。它表示的并不是对象自身，而是可通过telnet协议访问的交互式应用程序（资源）。
  ```html
  基本格式：
  telnet://<user>:<pasworld>@<host>:<port>/
  示例：
  telnet://slurp:webhound@joes-hardware.com:23/
  ```
  * http：超文本传输协议方案，除了没有用户名和密码之外，与通用的URL格式相符。默认端口80
  ```html
  基本格式：
  http://<host>:<port>/<path>?<query>#<frag>
  示例：
  http://www.joes-hardware.com:80/index.html
  ```
  * https:
  方案https与方案http是一对。唯一的区别在于方案https使用了网景的SSL，SSL为HTTP连接提供了端到端的加密机制。其语法与HTTP的语法相同，默认端口为443
  ```html
  基本格式：
  https://<host>:<port>/<path>?<query>#<frag>
  示例：
  https://www.joes-hardware.com:80/index.html
  ```
  * mailto：Mailto URL指向的是E-mail地址。由于En-mail的行为与其他方案都都有所不同（它并不指向任何可以直接访问的对象），所以mailto URL的格式与标准URL的格式也有所不同。
  ```html
  基本格式：
  mailto:<RFC-822-addr-spec>
  示例：
  mailto:joe@joes-hardware.com
  ```
  * ftp：文件传输协议URL可以用来从FTP服务器上下载或身其上载文件，并获取FTP服务器上的目录结构内容的列表。在Web和URL出现之前FTP就已经存在了。Web应用程序将FTP作为一种数据访问方案使用。URL语法遵循下列通用格式。
  ```html
  基本格式：
  ftp://<user>:<password>@<host>:<port>/<path>;<params>
  示例：
  ftp://anonymous:joe%40joes@prep.ai.mit.edu:21/pub/gnu/
  ```
  * rtsp,rtspu：RTSP URL是可以通过实时流传输协议（Real Time Streaming Protocol）解析的音/视频媒体资源的标识符。方案rtspu中的u表示UDP协议来获取资源的。
  ```html
  基本格式：
  rtsp://<user>:<password>@<host>:<port>/<path>
  示例：rtsp://www.joes-hardware.com:554/interview/cto_video
  ```

## 二、HTTP请求的事务逻辑

### 2.1 概念
一个HTTP 事务由一条（从客户端发往服务器的）请求命令和一个（从服务器发回客户端的）响应结果组成。这种通信是通过名为HTTP 报文（HTTP message）的格式化数据块进行的

* HTTP 报文包括以下三个部分。
  * 起始行
```
报文的第一行就是起始行，在请求报文中用来说明要做些什么，在响应报文中说明出现了什么情况。
```
  * 首部字段
```
起始行后面有零个或多个首部字段。每个首部字段都包含一个名字和一个值，为了便于解析，两者之间用冒号（:）来分隔。首部以一个空行结束。添加一个首部字段和添加新行一样简单。
```
  * 主体
```
空行之后就是可选的报文主体了，其中包含了所有类型的数据。请求主体中包括了要发送给Web 服务器的数据；响应主体中装载了要返回给客户端的数据。起始行和首部都是文本形式且都是结构化的，而主体则不同，主体中可以包含任意的二进制数据（比如图片、视频、音轨、软件程序）。当然，主体中也可以包含文本。
```

### 2.2 HTTP请求的事务逻辑之连接

HTTP 是个应用层协议。HTTP 无需操心网络通信的具体细节；它把联网的细节都交给了通用、可靠的因特网传输协议TCP/IP。只要建立了TCP 连接，客户端和服务器之间的报文交换就不会丢失、不会被破坏，也不会在接收时出现错序了。

* TCP 提供了：
  * 无差错的数据传输；
  * 按序传输（数据总是会按照发送的顺序到达）；
  * 未分段的数据流（可以在任意时刻以任意尺寸将数据发送出去）

用网络术语来说，HTTP 协议位于TCP 的上层。HTTP 使用TCP 来传输其报文数据。

* HTTP——————应用层
* TCP ——————传输层
* IP  ——————网络层
* 网络特有的链路接口——————数据链路层
* 物理网络硬件——————物理层

在HTTP 客户端向服务器发送报文之前，需要用网际协议（Internet Protocol，IP）地址和端口号在客户端和服务器之间建立一条TCP/IP 连接

* 步骤如下：
  * (a) 浏览器从URL 中解析出服务器的主机名；
  * (b) 浏览器将服务器的主机名转换成服务器的IP 地址；
  * (c) 浏览器将端口号（如果有的话）从URL 中解析出来；
  * (d) 浏览器建立一条与Web 服务器的TCP 连接；
  * (e) 浏览器向服务器发送一条HTTP 请求报文；
  * (f) 服务器向浏览器回送一条HTTP 响应报文；
  * (g) 关闭连接，浏览器显示文档。

### 2.3 TCP/IP的三次握手/四次挥手

>客户端和服务端通信前要进行连接，“3次握手”的作用就是双方都能明确自己和对方的收、发能力是正常的。

* 第一次握手：客户端向服务端发送网络包, 当服务端接受到后就可以得知:客户端可以正常的发送信息,以及服务端可以正常的接受信息
* 第二次握手：服务端向客户端发送网络包, 当客户端接受到后就可以得知:服务端可以正常接受信息和发送信息, 并且自己是可以正常的发送和接受信息
* 第三次握手：客户端向服务端发送网络包, 当服务端接受到后就可以得知:客户端的发送和接受能力正常,自己的发送和接受能力也正常

>当客户端与服务器端关闭一个链接通道时,同样需要双方的确认才行, 这个确认的过程需要四个步骤. 与建立连接只能是客户端向服务端发送不同, 关闭链接可以有任意一方发起
* 第一次挥手：发起方发送 FIN报文，代表断开连接
* 第二次挥手：接收方响应 ACK(确认字符) 报文，并在自己发送完未处理的报文后发送 FIN 报文
* 第三次挥手：发起方接收 ACK 报文后等待接收方的 FIN 报文，收到后发送 ACK 报文，自己进入 TIME_WAIT 状态，等待 2MSL(MSL是最大的报文存活时间,一般是30s,60s或是120s,主要是怕接收方没有接受到ACK报文) 后关闭连接
* 第四次挥手：接收方收到 ACK 报文，关闭连接


### 2.4 常见的业务结构组件

* 代理位于客户端和服务器之间，接收所有客户端的HTTP 请求，并将这些请求转发给服务器（可能会对请求进行修改之后转发）。最常见的有一些绿坝(青少年网页内容过滤系统)或是VPN
* 代理位于客户端和服务器之间，接收所有客户端的HTTP 请求，并将这些请求转发给服务器（可能会对请求进行修改之后转发）。最常见的有一些绿坝(青少年网页内容过滤系统)或是VPN
* 网关（gateway）是一种特殊的服务器，作为其他服务器的中间实体使用。通常用于将HTTP 流量转换成其他的协议。网关接受请求时就好像自己是资源的源端服务器一样。客户端可能并不知道自己正在与一个网关进行通信。
  * 网关（gateway）是一种特殊的服务器，作为其他服务器的中间实体使用。通常用于将HTTP 流量转换成其他的协议。网关接受请求时就好像自己是资源的源端服务器一样。客户端可能并不知道自己正在与一个网关进行通信。
* 隧道（tunnel）是建立起来之后，就会在两条连接之间对原始数据进行盲转发(只负责转发数据但是不管转发的是啥)的HTTP 应用程序。HTTP 隧道通常用来在一条或多条HTTP 连接上转发非HTTP 数据，转发时不会窥探数据。

## 三、HTTP报文
### 3.1 报文流入源端服务器

HTTP 报文是在HTTP 应用程序之间发送的数据块。这些数据块以一些文本形式的元信息（meta-information）开头，这些信息描述了报文的内容及含义，后面跟着可选的数据部分。这些报文在客户端、服务器和代理之间流动。术语“流入”、“流出”、“上游”及“下游”都是用来描述报文方向的。

HTTP 使用术语流入（inbound）和流出（outbound）来描述事务处理（transaction）的方向。报文流入源端服务器，工作完成之后，会流回用户的Agent 代理中

HTTP 报文会像河水一样流动。不管是请求报文还是响应报文，所有报文都会向下游（downstream） 流动。所有报文的发送者都在接收者的上游（upstream）

### 3.1 报文格式详解

所有的HTTP 报文都可以分为两类： 请求报文（request message） 和响应报文（response message）。请求报文会向Web 服务器请求一个动作。响应报文会将请求的结果返回给客户端。请求和响应报文的基本报文结构相同
```html
<!--这是请求报文的格式：-->
<method> <request-URL> <version>
<headers>
<entity-body>
<!--这是响应报文的格式（注意，只有起始行的语法有所不同）：-->
<version> <status> <reason-phrase>
<headers>
<entity-body>
```
所有的HTTP 报文都以一个起始行作为开始。请求报文的起始行说明了要做些什么。响应报文的起始行说明发生了什么。

* 下面是对各部分的简要描述。
  * 方法（method）
客户端希望服务器对资源执行的动作。是一个单独的词，比如GET、HEAD 或POST。
    * POST: 向服务器发送数据如表单
    * PUT: 将请求的主体部分存储在服务器上
    * GET: 从服务器上获取一份文档
    * DELETE: 从服务器上删除一份文档
    * HEAD: 只从服务器上获取文档的首部
    * OPTIONS: 决定可以在服务器上执行哪些方法
    * TRACE: 对可能经过代理服务器传送到服务器上的报文进行追踪
  * 请求URL（request-URL）
命名了所请求资源，或者URL 路径组件的完整URL。如果直接与服务器进行对话，只要URL 的路径组件是资源的绝对路径，通常就不会有什么问题——服务器可以假定自己是URL 的主机/ 端口。
  * 版本（version）
报文所使用的HTTP 版本，其格式看起来是这样的：HTTP/<major>.<minor>其中主要版本号（major）和次要版本号（minor）都是整数。
  * 状态码（status-code）
这三位数字描述了请求过程中所发生的情况。每个状态码的第一位数字都用于描述状态的一般类别（“成功”、“出错”等）。
  * 原因短语（reason-phrase）
数字状态码的可读版本，包含行终止序列之前的所有文本。本章稍后提供了HTTP 规范定义的所有状态码的原因短语示例。原因短语只对人类有意义，因此，比如说，尽管响应行HTTP/1.0 200 NOT OK 和 HTTP/1.0 200 OK 中原因短语的含义不同，但同样都会被当作成功指示处理
  * 首部（header）
可以有零个或多个首部，每个首部都包含一个名字，后面跟着一个冒号（:），然后是一个可选的空格，接着是一个值，最后是一个CRLF。首部是由一个空行（CRLF）结束的，表示了首部列表的结束和实体主体部分的开始。有些HTTP 版本，比如HTTP/1.1，要求有效的请求或响应报文中必须包含特定的首部
  * 实体的主体部分(entity-body)
实体的主体部分包含一个由任意数据组成的数据块。并不是所有的报文都包含实体的主体部分，有时，报文只是以一个CRLF 结束

### 3.2 报文状态码详解

可以通过三位数字代码对不同状态码进行分类：
* 200-299 之间的状态码表示成功
* 300-399 之间的状态码表示资源已经被移走了
* 400-499 之间的状态码表示客户端的请求出错了
* 500-599 之间的代码表示服务器出错了
```
200: "服务器成功返回请求的数据。",
201: "新建或修改数据成功。",
202: "一个请求已经进入后台排队（异步任务）。",
204: "删除数据成功。",
400: "发出的请求有错误，服务器没有进行新建或修改数据的操作。",
401: "用户没有权限（令牌、用户名、密码错误）。",
403: "用户得到授权，但是访问是被禁止的。",
404: "发出的请求针对的是不存在的记录，服务器没有进行操作。",
406: "请求的格式不可得。",
410: "请求的资源被永久删除，且不会再得到的。",
422: "当创建一个对象时，发生一个验证错误。",
500: "服务器发生错误，请检查服务器。",
502: "网关错误。",
503: "服务不可用，服务器暂时过载或维护。",
504: "网关超时。
```
### 3.3 报文首部详解

HTTP首部可以分为以下几类：
* 通用首部：即可以出现在请求报文中又可以出现在响应报文中。
* 请求首部：提供更多有关请求的信息。
* 响应首部：提供更多有关响应的信息。
* 实体首部：描述主体的长度和内容，或都资源自身。
* 扩展首部：规范中没有定义的新首部。每个HTTP首部都有一种简单的语法：名字后面跟着冒号，然后跟上可选的空格，再跟上字段值，最后是一个CRLF

* 通用首部：不论报文是何类型，都为其提供一些有用信息
  * Connection：允许客户端和服务器指定与请求/响应连接有关的选项。
  * Date‘：提供日期和时间标志，说明报文是什么时间创建的。
  * MIME-Version：给出发送端使用的MIME版本。
  * Trailer：如果报文采用了分块传输编码(chunked transfer encoding)方式，就可以用这个首部列出位于报文拖挂(trailer)部分的首部集合。
  * Transfer-Encoding：告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式。
  * Update：给出了发送端可能想要“升级”使用的新版本或协议。
  * Via：显示了报文经过的中间节点（代理、网关）。
* 请求首部：只在请求报文中有意义的首部
  * Client-IP：提供了运行客户端的机器的IP地址
  * From：提供了客户端用户的E-mail地址
  * host：给出了接收请求的服务器的主机名和端口号
  * Referer：提供了包含当前请求URI的文档的URL
  * UA-Color：提供了与客户端显示器的显示颜色有关的信息
  * UA-cpu：提供了与客户端CPU的类型或制造商
  * UA-Disp：提供了与客户端显示器（屏幕）能力有送的信息
  * UA-os：给出了运行在客户端机器上的操作系统名称及版本
  * UA-Pixels：提供了客户端显示器的像素信息
  * User-Agent：将发起请求的应用程序名称告知服务器
  * Accept首部：首部为客户端提供了一种将其喜好和能力告知服务器的方式
    * Accept：告诉服务器能够发送哪些媒体类型
    * Accept-Charset：告诉服务器能够发送哪些字符集
    * Accept-Encoding：告诉服务器能够发送哪些编码方式
    * Accept-Language：告诉服务器能够发送哪些语言
    * TE：告诉服务器可以使用哪些扩展传输编码
  * 有时客户端希望为请求加上某些限制:
    * Expect：允许客户端列出某请求所要求的服务器行为
    * If-Match：如果实体标记与文档当前的实体票房相匹配，就获取这份文档
    * If-Modified-Since：除非在某个指定的日期之后资源被个性过，否则就限制这个请求
    * If-None-Match：如果提供的实体标记与当前文档的实体票房不相符，就获取文档
    * If-Range：允许文档的某个范围进行条件请求
    * If-Unmodified-Since：除非在某个指定日期之后资源没有被修改过，否则就限制这个请求
    *  Range：如果服务器支持范围请求，就请求资源的指定范围
    *  Authorization：包含了客户端提供给服务器，以便对其自身进行认证的数据
    *  Cookie：客户端用它向服务器传送一个令牌--它并不是真正的安全首部，但确实隐含了安全功能。
    *  Cookie2：用来说明请求端支持的cookie版本
* 响应首部：响应首部提供的信息有助于客户端处理响应，并在将来发起更好的请求
  * Age：（从最初创建开始）响应持续时间
  * Public：服务器为其资源支持的请求方法列表
  * Retry-After：如果资源不可用的话，在此日期或时间重试
  * Server：服务器应用程序软件的名称和版本
  * Title：对HTML文档来说，就是HTML文档的源端给出的标题
  * Warning：比原因短语中更详细一些的警告报文
* 内容首部：
  * Content-Base：解析主体中的相对URL时使用的基础URL
  * Content-Encoding：对主体执行的任意编码方式
  * Content-Language：理解主体时最适宜使用的自然语言
  * Content-Length：主体的长度或尺寸
  * Content-Location：资源实际所处的位置
  * Content-MD5：主体的MD5校验和
  * Content-Range：在整个资源中此实体表示的字节范围
  * Content-Type：这个主体的对象类型

### 3.4 抓包小工具Fiddler